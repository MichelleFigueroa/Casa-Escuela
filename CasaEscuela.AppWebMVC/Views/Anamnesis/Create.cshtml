@model CasaEscuela.BL.DTOs.AnamnesisRegistroDTO

@{
    ViewData["Title"] = "Registro de Anamnesis";
}

<div class="container py-4">
    <form asp-action="Save" id="anamnesisForm" enctype="multipart/form-data">
        <input type="hidden" asp-for="Estudiante.IdEstudiante" />
        <input type="hidden" asp-for="Anamnesis.IdAnamnesis" />

        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        <input type="hidden" asp-for="Estudiante.IdEstudiante" />
        <input type="hidden" asp-for="Anamnesis.IdAnamnesis" />
        <input type="hidden" asp-for="Anamnesis.IdEstudiante" />

        <!-- ðŸ§‘â€ðŸŽ“ Secciâ”œâ”‚n A: Informaciâ”œâ”‚n del Estudiante -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="card-title fw-bold mb-0 text-primary">
                    <i class="ti ti-school me-2"></i>Informaciâ”œâ”‚n del Estudiante
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Codigo" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Codigo" class="form-control" placeholder="Ej: EST001" />
                        <span asp-validation-for="Estudiante.Codigo" class="text-danger small"></span>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Nombres" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Nombres" class="form-control" required />
                        <span asp-validation-for="Estudiante.Nombres" class="text-danger small"></span>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Apellidos" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Apellidos" class="form-control" required />
                        <span asp-validation-for="Estudiante.Apellidos" class="text-danger small"></span>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.FechaNacimiento" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.FechaNacimiento" type="date" class="form-control" />
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Sexo" class="form-label fw-bold"></label>
                        <select asp-for="Estudiante.Sexo" class="form-select" required>
                            <option value="">Seleccione...</option>
                            <option value="1">Masculino</option>
                            <option value="2">Femenino</option>
                            <option value="3">Otro</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.NivelEscolarId" class="form-label fw-bold"></label>
                        <select asp-for="Estudiante.NivelEscolarId" class="form-select" asp-items="ViewBag.NivelesEscolares">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Grado" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Grado" class="form-control" />
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Seccion" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Seccion" class="form-control" />
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Estudiante.Jornada" class="form-label fw-bold"></label>
                        <input asp-for="Estudiante.Jornada" class="form-control" />
                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Secciâ”œâ”‚n B: Miembros de la Familia -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title fw-bold mb-0 text-primary">
                    <i class="ti ti-users me-2"></i>Miembros de la Familia
                </h5>
                <button type="button" class="btn btn-primary btn-sm rounded shadow-sm" onclick="addFamiliarRow()">
                    <i class="ti ti-plus me-1"></i>Agregar Familiar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle" id="familiaresTable">
                        <thead class="bg-light text-center small">
                            <tr>
                                <th style="width: 15%">Parentesco</th>
                                <th style="width: 15%">Nombres</th>
                                <th style="width: 15%">Apellidos</th>
                                <th style="width: 8%">Edad</th>
                                <th style="width: 10%">TelÃ©fono</th>
                                <th style="width: 12%">Escolaridad</th>
                                <th style="width: 12%">OcupaciÃ³n</th>
                                <th style="width: 5%">Vive?</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ int i = 0; }
                            @if (Model.Familiares != null && Model.Familiares.Any())
                            {
                                foreach (var familiar in Model.Familiares)
                                {
                                    <tr>
                                        <td>
                                            <select name="Familiares[@i].TipoParentesco" class="form-select form-select-sm">
                                                <!option value="1" @(familiar.TipoParentesco == 1 ? "selected" : "")>Padre</!option>
                                                <!option value="2" @(familiar.TipoParentesco == 2 ? "selected" : "")>Madre</!option>
                                                <!option value="3" @(familiar.TipoParentesco == 3 ? "selected" : "")>Encargado</!option>
                                                <!option value="4" @(familiar.TipoParentesco == 4 ? "selected" : "")>Otro</!option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="Familiares[@i].Nombres" value="@familiar.Nombres" class="form-control form-control-sm" required /></td>
                                        <td><input type="text" name="Familiares[@i].Apellidos" value="@familiar.Apellidos" class="form-control form-control-sm" required /></td>
                                        <td><input type="number" name="Familiares[@i].Edad" value="@familiar.Edad" class="form-control form-control-sm" /></td>
                                        <td><input type="text" name="Familiares[@i].Telefono" value="@familiar.Telefono" class="form-control form-control-sm" /></td>
                                        <td><input type="text" name="Familiares[@i].Escolaridad" value="@familiar.Escolaridad" class="form-control form-control-sm" /></td>
                                        <td><input type="text" name="Familiares[@i].Ocupacion" value="@familiar.Ocupacion" class="form-control form-control-sm" /></td>
                                        <td class="text-center">
                                            <input type="checkbox" class="form-check-input" onchange="this.nextElementSibling.value = this.checked" @(familiar.ViveConEstudiante ? "checked" : "") />
                                            <input type="hidden" name="Familiares[@i].ViveConEstudiante" value="@(familiar.ViveConEstudiante ? "true" : "false")" />
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-danger btn-sm p-1" onclick="this.closest('tr').remove()"><i class="ti ti-trash"></i></button>
                                        </td>
                                    </tr>
                                    i++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ðŸ§  Secciâ”œâ”‚n C: Detalles de la Anamnesis -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="card-title fw-bold mb-0 text-primary">
                    <i class="ti ti-clipboard me-2"></i>Detalles de la Anamnesis
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label asp-for="Anamnesis.ViveConId" class="form-label fw-bold"></label>
                        <select asp-for="Anamnesis.ViveConId" class="form-select" asp-items="ViewBag.ViveCon">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Anamnesis.TipoFamiliaId" class="form-label fw-bold"></label>
                        <select asp-for="Anamnesis.TipoFamiliaId" class="form-select" asp-items="ViewBag.TiposFamilia">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label asp-for="Anamnesis.TipoPartoId" class="form-label fw-bold"></label>
                        <select asp-for="Anamnesis.TipoPartoId" class="form-select" asp-items="ViewBag.TiposParto">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="form-check form-switch mt-4">
                            <input asp-for="Anamnesis.EmbarazoControlado" class="form-check-input" type="checkbox">
                            <label class="form-check-label fw-bold" asp-for="Anamnesis.EmbarazoControlado"></label>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <label asp-for="Anamnesis.ComplicacionesEmbarazo" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.ComplicacionesEmbarazo" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.CondicionesSalud" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.CondicionesSalud" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.DesarrolloLenguaje" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.DesarrolloLenguaje" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.DesarrolloMotor" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.DesarrolloMotor" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.SituacionFamiliar" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.SituacionFamiliar" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <label asp-for="Anamnesis.Observaciones" class="form-label fw-bold"></label>
                        <textarea asp-for="Anamnesis.Observaciones" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.FechaEntrevista" class="form-label fw-bold"></label>
                        <input asp-for="Anamnesis.FechaEntrevista" type="date" class="form-control" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label asp-for="Anamnesis.Entrevistador" class="form-label fw-bold"></label>
                        <input asp-for="Anamnesis.Entrevistador" class="form-control" />
                    </div>
                     <div class="col-12 mt-4 pt-3 border-top">
                        <label class="form-label fw-bold"><i class="ti ti-paperclip me-2"></i>Adjuntar Documentos (Partida Nacimiento, Notas anteriores, etc)</label>
                        
                        <!-- Lista de Adjuntos Existentes -->
                        @if (Model.Anamnesis.AdjuntosExistentes != null && Model.Anamnesis.AdjuntosExistentes.Any())
                        {
                            <div class="list-group mb-3">
                                @foreach (var adjunto in Model.Anamnesis.AdjuntosExistentes)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <i class="ti ti-file-text text-primary me-3 fs-4"></i>
                                            <div>
                                                <h6 class="mb-0 fw-bold">@adjunto.NombreArchivo</h6>
                                                <small class="text-muted">Subido: @adjunto.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</small>
                                            </div>
                                        </div>
                                        <div class="btn-group">
                                            <a href="@Url.Action("DescargarAdjunto", "Anamnesis", new { id = adjunto.Id })" class="btn btn-outline-primary btn-sm" target="_blank" title="Descargar">
                                                <i class="ti ti-download"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmarEliminarAdjunto(@adjunto.Id)" title="Eliminar">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <input type="file" name="Anamnesis.ArchivosSubidos" multiple class="form-control" />
                        <div class="form-text">Puede seleccionar mÃºltiples archivos.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones -->
        <div class="d-flex flex-column flex-md-row justify-content-end gap-2 mb-4">
            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary rounded shadow-sm px-4">
                Cancelar
            </a>
            <button type="submit" class="btn btn-primary rounded shadow-sm px-4">
                Guardar Anamnesis
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let familiarIndex = @(Model.Familiares != null ? Model.Familiares.Count : 0);

        function addFamiliarRow() {
            const tbody = document.querySelector('#familiaresTable tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>
                    <select name="Familiares[${familiarIndex}].TipoParentesco" class="form-select form-select-sm">
                        <option value="1">Padre</option>
                        <option value="2">Madre</option>
                        <option value="3">Encargado</option>
                        <option value="4">Otro</option>
                    </select>
                </td>
                <td><input type="text" name="Familiares[${familiarIndex}].Nombres" class="form-control form-control-sm" required /></td>
                <td><input type="text" name="Familiares[${familiarIndex}].Apellidos" class="form-control form-control-sm" required /></td>
                <td><input type="number" name="Familiares[${familiarIndex}].Edad" class="form-control form-control-sm" /></td>
                <td><input type="text" name="Familiares[${familiarIndex}].Telefono" class="form-control form-control-sm" /></td>
                <td><input type="text" name="Familiares[${familiarIndex}].Escolaridad" class="form-control form-control-sm" /></td>
                <td><input type="text" name="Familiares[${familiarIndex}].Ocupacion" class="form-control form-control-sm" /></td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" onchange="this.nextElementSibling.value = this.checked" />
                    <input type="hidden" name="Familiares[${familiarIndex}].ViveConEstudiante" value="false" />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm p-1" onclick="this.closest('tr').remove()"><i class="ti ti-trash"></i></button>
                </td>
            `;

            tbody.appendChild(row);
            familiarIndex++;
        }

        function confirmarEliminarAdjunto(idAdjunto) {
            if (confirm('Â¿EstÃ¡ seguro de que desea eliminar este archivo adjunto?')) {
                // Create a form to post to the delete action
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("EliminarAdjunto", "Anamnesis")';
                
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = idAdjunto;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}
